---
title: Security
description: Plugin for sanitizing markdown output by removing dangerous HTML elements and attributes.
icon: i-lucide-shield-check
---

The `comark/plugins/security` plugin provides automatic security sanitization for parsed markdown content. It removes dangerous HTML elements and validates attributes to prevent XSS attacks and other security vulnerabilities.


## Basic Usage

The security plugin is included in comark core package and available under `comark/plugins/security` path.

### Registering the Plugin

```typescript
import { parse } from 'comark'
import security from 'comark/plugins/security'

const result = await parse(content, {
  plugins: [
    security({
      drop: ['script', 'iframe']
    })
  ]
})
```

### Default Configuration

By default, the security plugin:

```typescript
security({
  drop: ['script']  // Drops all <script> tags
})
```

## Security Features

### 1. Tag Dropping

Remove dangerous HTML elements entirely:

```typescript
const result = await parse(content, {
  plugins: [
    security({
      drop: ['script', 'iframe', 'object', 'embed']
    })
  ]
})
```

**Input:**
```html
<p>Safe content</p>
<script>alert('XSS')</script>
<p>More content</p>
```

**Output:**
```html
<p>Safe content</p>
<p>More content</p>
```

### 2. Event Handler Removal

Automatically removes all `on*` event handlers:

**Blocked attributes:**
- `onclick`
- `onload`
- `onerror`
- `onmouseover`
- And all other `on*` attributes

**Input:**
```html
<div onclick="alert('XSS')">Click me</div>
<img src="x" onerror="alert('XSS')">
```

**Output:**
```html
<div>Click me</div>
<img src="x">
```

### 3. Dangerous Attribute Removal

Removes attributes that can be used for attacks:

**Blocked attributes:**
- `srcdoc` - Can contain malicious HTML
- `formaction` - Can redirect forms to malicious endpoints

**Input:**
```html
<iframe srcdoc="<script>alert('XSS')</script>"></iframe>
<button formaction="javascript:alert('XSS')">Submit</button>
```

**Output:**
```html
<iframe></iframe>
<button>Submit</button>
```

### 4. Protocol Validation

Validates `href` and `src` attributes to block dangerous protocols:

**Blocked protocols:**
- `javascript:`
- `data:text/html`
- `vbscript:`
- `data:text/javascript`
- `data:text/vbscript`
- `data:text/css`
- `data:text/plain`
- `data:text/xml`

**Input:**
```html
<a href="javascript:alert('XSS')">Click</a>
<a href="data:text/html,<script>alert('XSS')</script>">Click</a>
<img src="javascript:alert('XSS')">
```

**Output:**
```html
<a>Click</a>
<a>Click</a>
<img>
```

**Safe protocols allowed:**
```html
<a href="https://example.com">Safe link</a>
<a href="/relative/path">Safe link</a>
<a href="#anchor">Safe link</a>
<img src="https://example.com/image.png">
<img src="data:image/png;base64,...">  <!-- Image data URLs are safe -->
```

### 5. Unsafe Tag Attribute Stripping

Certain tags have all their attributes removed:

**Unsafe tags:**
- `object`

**Input:**
```html
<object data="malicious.swf" type="application/x-shockwave-flash"></object>
```

**Output:**
```html
<object></object>
```

## Examples

### Complete Security Setup

```typescript
import { parse } from 'comark'
import security from 'comark/plugins/security'

const content = `
# My Article

<p>Safe paragraph</p>

<script>alert('XSS')</script>

<a href="javascript:alert('XSS')">Malicious link</a>

<div onclick="alert('XSS')">Click me</div>

<iframe src="https://example.com"></iframe>
`

const result = await parse(content, {
  plugins: [
    security({
      drop: ['script', 'iframe']
    })
  ]
})

console.log(result.nodes)
// Script and iframe tags are completely removed
// onclick attribute is removed from div
// javascript: href is blocked
```

### User-Generated Content

Perfect for sanitizing user-submitted markdown:

```typescript
import { parse } from 'comark'
import security from 'comark/plugins/security'

async function sanitizeUserContent(markdown: string) {
  return await parse(markdown, {
    plugins: [
      security({
        drop: [
          'script',
          'iframe',
          'object',
          'embed',
          'link',
          'style',
        ]
      })
    ]
  })
}

// Usage in API endpoint
app.post('/api/comments', async (req, res) => {
  const { content } = req.body

  const sanitized = await sanitizeUserContent(content)

  // Safe to store and display
  await db.comments.create({
    content: sanitized
  })
})
```

### Blog Comments with Security

```tsx
import { Comark } from 'comark/react'
import security from 'comark/plugins/security'

interface CommentProps {
  content: string
  author: string
}

export default function Comment({ content, author }: CommentProps) {
  const options = {
    plugins: [
      security({
        drop: ['script', 'iframe', 'object', 'embed']
      })
    ]
  }

  return (
    <div className="comment">
      <strong>{author}</strong>
      <Comark options={options}>{content}</Comark>
    </div>
  )
}
```

### Documentation Platform

```vue
<script setup>
import { Comark } from 'comark/vue'
import security from 'comark/plugins/security'

const content = ref('')

const options = {
  plugins: [
    security({
      drop: ['script']  // Only drop scripts, allow other HTML
    })
  ]
}
</script>

<template>
  <article class="prose">
    <Comark :options="options">{{ content }}</Comark>
  </article>
</template>
```

## Configuration Options

### `drop`

Array of HTML tag names to completely remove from the output:

```typescript
security({
  drop: ['script', 'iframe', 'object', 'embed', 'link', 'style']
})
```

**Common tags to drop:**
- `script` - JavaScript execution
- `iframe` - Can load external content
- `object` - Can embed plugins/Flash
- `embed` - Similar to object
- `link` - Can load external stylesheets
- `style` - Can contain CSS with `javascript:` URLs
- `base` - Can change base URL for relative links
- `meta` - Can set refresh/redirect

## API Reference

### `security(options): ComarkPlugin`

Creates a security sanitization plugin.

**Parameters:**
- `options.drop` - Array of tag names to remove (default: `[]`)

**Returns:** A Comark plugin that sanitizes content.

**Features:**
- Removes specified HTML tags entirely
- Strips all `on*` event handler attributes
- Removes dangerous attributes (`srcdoc`, `formaction`)
- Validates `href` and `src` for dangerous protocols
- Removes all attributes from unsafe tags
- Cleans empty `id` attributes
- Normalizes `className` to `class`

## Security Best Practices

### 1. Always Use with User-Generated Content

```typescript
// ✅ Good - Always sanitize user content
const userComment = await parse(userInput, {
  plugins: [security({ drop: ['script', 'iframe'] })]
})

// ❌ Bad - Never trust user input
const userComment = await parse(userInput)
```

### 2. Drop Dangerous Tags

```typescript
// ✅ Good - Drop potentially dangerous tags
security({
  drop: ['script', 'iframe', 'object', 'embed', 'link', 'style']
})

// ⚠️ Risky - Only dropping script may not be enough
security({
  drop: ['script']
})
```

### 3. Combine with CSP Headers

Use Content Security Policy headers for defense in depth:

```typescript
// Express.js example
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'none';"
  )
  next()
})
```

### 4. Sanitize Before Storage

```typescript
// ✅ Good - Sanitize before storing
async function saveArticle(content: string) {
  const sanitized = await parse(content, {
    plugins: [security({ drop: ['script'] })]
  })

  await db.articles.create({ content: sanitized })
}

// ❌ Bad - Sanitizing on read allows malicious content in DB
async function getArticle(id: string) {
  const article = await db.articles.findById(id)
  return parse(article.content, {
    plugins: [security({ drop: ['script'] })]
  })
}
```

## What Gets Sanitized

### Automatically Blocked

✅ **Event handlers:**
```html
<div onclick="...">        → <div>
<img onerror="...">        → <img>
<body onload="...">        → <body>
```

✅ **Dangerous protocols:**
```html
<a href="javascript:...">     → <a>
<a href="data:text/html,..."> → <a>
<iframe src="vbscript:...">   → <iframe>
```

✅ **Dangerous attributes:**
```html
<iframe srcdoc="...">      → <iframe>
<button formaction="...">  → <button>
```

### Safe to Use

✅ **Standard HTML:**
```html
<p>, <div>, <span>, <a>, <img>, <h1>-<h6>, <ul>, <ol>, <li>
```

✅ **Safe protocols:**
```html
https://, http://, mailto:, tel:, #anchor, /relative
```

✅ **Safe attributes:**
```html
id, class, style (sanitized), title, alt, src (validated), href (validated)
```

✅ **Image data URLs:**
```html
<img src="data:image/png;base64,...">
<img src="data:image/jpeg;base64,...">
```

## Performance

The security plugin:
- Runs during the `post` phase (after parsing)
- Uses AST traversal for efficient processing
- O(n) complexity where n is the number of nodes
- Minimal performance impact
- Runs once during parsing, not on every render

## See Also

- [Summary Plugin](/plugins/summary) - Extract content summaries
- [TOC Plugin](/plugins/toc) - Generate table of contents
- [Emoji Plugin](/plugins/emoji) - Convert emoji shortcodes
- [Parse API](/api/parse) - Parsing markdown content
