import type { ComarkPlugin, MarkdownItPlugin } from 'comark'

// Common emoji definitions (200+ emojis)
// Organized by category for easier maintenance
const EMOJI_MAP = new Map<string, string>([
  ['grinning', 'ðŸ˜€'],
  ['smiley', 'ðŸ˜ƒ'],
  ['smile', 'ðŸ˜„'],
  ['grin', 'ðŸ˜'],
  ['laughing', 'ðŸ˜†'],
  ['satisfied', 'ðŸ˜†'],
  ['sweat_smile', 'ðŸ˜…'],
  ['joy', 'ðŸ˜‚'],
  ['wink', 'ðŸ˜‰'],
  ['blush', 'ðŸ˜Š'],
  ['innocent', 'ðŸ˜‡'],
  ['heart_eyes', 'ðŸ˜'],
  ['kissing_heart', 'ðŸ˜˜'],
  ['kissing', 'ðŸ˜—'],
  ['kissing_closed_eyes', 'ðŸ˜š'],
  ['kissing_smiling_eyes', 'ðŸ˜™'],
  ['yum', 'ðŸ˜‹'],
  ['stuck_out_tongue', 'ðŸ˜›'],
  ['stuck_out_tongue_winking_eye', 'ðŸ˜œ'],
  ['stuck_out_tongue_closed_eyes', 'ðŸ˜'],
  ['neutral_face', 'ðŸ˜'],
  ['expressionless', 'ðŸ˜‘'],
  ['no_mouth', 'ðŸ˜¶'],
  ['smirk', 'ðŸ˜'],
  ['unamused', 'ðŸ˜’'],
  ['relieved', 'ðŸ˜Œ'],
  ['pensive', 'ðŸ˜”'],
  ['sleepy', 'ðŸ˜ª'],
  ['sleeping', 'ðŸ˜´'],
  ['mask', 'ðŸ˜·'],
  ['dizzy_face', 'ðŸ˜µ'],
  ['sunglasses', 'ðŸ˜Ž'],
  ['confused', 'ðŸ˜•'],
  ['worried', 'ðŸ˜Ÿ'],
  ['open_mouth', 'ðŸ˜®'],
  ['hushed', 'ðŸ˜¯'],
  ['astonished', 'ðŸ˜²'],
  ['flushed', 'ðŸ˜³'],
  ['frowning', 'ðŸ˜¦'],
  ['anguished', 'ðŸ˜§'],
  ['fearful', 'ðŸ˜¨'],
  ['cold_sweat', 'ðŸ˜°'],
  ['disappointed_relieved', 'ðŸ˜¥'],
  ['cry', 'ðŸ˜¢'],
  ['sob', 'ðŸ˜­'],
  ['scream', 'ðŸ˜±'],
  ['confounded', 'ðŸ˜–'],
  ['persevere', 'ðŸ˜£'],
  ['disappointed', 'ðŸ˜ž'],
  ['sweat', 'ðŸ˜“'],
  ['weary', 'ðŸ˜©'],
  ['tired_face', 'ðŸ˜«'],
  ['triumph', 'ðŸ˜¤'],
  ['rage', 'ðŸ˜¡'],
  ['angry', 'ðŸ˜ '],
  ['smiling_imp', 'ðŸ˜ˆ'],
  ['imp', 'ðŸ‘¿'],
  ['skull', 'ðŸ’€'],
  ['eyes', 'ðŸ‘€'],
  ['eye', 'ðŸ‘ï¸'],
  ['nose', 'ðŸ‘ƒ'],
  ['lips', 'ðŸ‘„'],
  ['tongue', 'ðŸ‘…'],
  ['heart', 'â¤ï¸'],
  ['yellow_heart', 'ðŸ’›'],
  ['green_heart', 'ðŸ’š'],
  ['blue_heart', 'ðŸ’™'],
  ['purple_heart', 'ðŸ’œ'],
  ['broken_heart', 'ðŸ’”'],
  ['thumbsup', 'ðŸ‘'],
  ['+1', 'ðŸ‘'],
  ['thumbsdown', 'ðŸ‘Ž'],
  ['-1', 'ðŸ‘Ž'],
  ['ok_hand', 'ðŸ‘Œ'],
  ['facepunch', 'ðŸ‘Š'],
  ['punch', 'ðŸ‘Š'],
  ['fist', 'âœŠ'],
  ['v', 'âœŒï¸'],
  ['wave', 'ðŸ‘‹'],
  ['hand', 'âœ‹'],
  ['raised_hand', 'âœ‹'],
  ['clap', 'ðŸ‘'],
  ['pray', 'ðŸ™'],
  ['point_up', 'â˜ï¸'],
  ['point_down', 'ðŸ‘‡'],
  ['point_left', 'ðŸ‘ˆ'],
  ['point_right', 'ðŸ‘‰'],
  ['raised_hands', 'ðŸ™Œ'],
  ['muscle', 'ðŸ’ª'],
  ['writing_hand', 'âœï¸'],
  ['nail_care', 'ðŸ’…'],
  ['selfie', 'ðŸ¤³'],
  ['fire', 'ðŸ”¥'],
  ['sparkles', 'âœ¨'],
  ['star', 'â­'],
  ['star2', 'ðŸŒŸ'],
  ['zap', 'âš¡'],
  ['boom', 'ðŸ’¥'],
  ['collision', 'ðŸ’¥'],
  ['100', 'ðŸ’¯'],
  ['tada', 'ðŸŽ‰'],
  ['confetti_ball', 'ðŸŽŠ'],
  ['balloon', 'ðŸŽˆ'],
  ['gift', 'ðŸŽ'],
  ['birthday', 'ðŸŽ‚'],
  ['cake', 'ðŸ°'],
  ['rocket', 'ðŸš€'],
  ['helicopter', 'ðŸš'],
  ['airplane', 'âœˆï¸'],
  ['boat', 'â›µ'],
  ['ship', 'ðŸš¢'],
  ['train', 'ðŸš‚'],
  ['bus', 'ðŸšŒ'],
  ['taxi', 'ðŸš•'],
  ['car', 'ðŸš—'],
  ['bike', 'ðŸš²'],
  ['checkered_flag', 'ðŸ'],
  ['medal', 'ðŸ…'],
  ['trophy', 'ðŸ†'],
  ['medal_sports', 'ðŸ…'],
  ['medal_military', 'ðŸŽ–ï¸'],
  ['soccer', 'âš½'],
  ['basketball', 'ðŸ€'],
  ['football', 'ðŸˆ'],
  ['baseball', 'âš¾'],
  ['tennis', 'ðŸŽ¾'],
  ['bowling', 'ðŸŽ³'],
  ['golf', 'â›³'],
  ['dart', 'ðŸŽ¯'],
  ['beer', 'ðŸº'],
  ['beers', 'ðŸ»'],
  ['wine_glass', 'ðŸ·'],
  ['cocktail', 'ðŸ¸'],
  ['coffee', 'â˜•'],
  ['pizza', 'ðŸ•'],
  ['hamburger', 'ðŸ”'],
  ['fries', 'ðŸŸ'],
  ['apple', 'ðŸŽ'],
  ['banana', 'ðŸŒ'],
  ['watermelon', 'ðŸ‰'],
  ['grapes', 'ðŸ‡'],
  ['strawberry', 'ðŸ“'],
  ['cherries', 'ðŸ’'],
  ['lemon', 'ðŸ‹'],
  ['peach', 'ðŸ‘'],
  ['pear', 'ðŸ'],
  ['pineapple', 'ðŸ'],
  ['tomato', 'ðŸ…'],
  ['eggplant', 'ðŸ†'],
  ['hot_pepper', 'ðŸŒ¶ï¸'],
  ['corn', 'ðŸŒ½'],
  ['bread', 'ðŸž'],
  ['croissant', 'ðŸ¥'],
  ['baguette_bread', 'ðŸ¥–'],
  ['cheese', 'ðŸ§€'],
  ['egg', 'ðŸ¥š'],
  ['poultry_leg', 'ðŸ—'],
  ['meat_on_bone', 'ðŸ–'],
  ['doughnut', 'ðŸ©'],
  ['cookie', 'ðŸª'],
  ['chocolate_bar', 'ðŸ«'],
  ['candy', 'ðŸ¬'],
  ['lollipop', 'ðŸ­'],
  ['ice_cream', 'ðŸ¦'],
  ['icecream', 'ðŸ¨'],
  ['shaved_ice', 'ðŸ§'],
  ['tea', 'ðŸµ'],
  ['sake', 'ðŸ¶'],
  ['champagne', 'ðŸ¾'],
  ['tropical_drink', 'ðŸ¹'],
  ['sunny', 'â˜€ï¸'],
  ['cloud', 'â˜ï¸'],
  ['umbrella', 'â˜‚ï¸'],
  ['snowflake', 'â„ï¸'],
  ['snowman', 'â›„'],
  ['rainbow', 'ðŸŒˆ'],
  ['ocean', 'ðŸŒŠ'],
  ['droplet', 'ðŸ’§'],
  ['zap', 'âš¡'],
  ['fire', 'ðŸ”¥'],
  ['star', 'â­'],
  ['moon', 'ðŸŒ™'],
  ['partly_sunny', 'â›…'],
  ['thunder_cloud_and_rain', 'â›ˆï¸'],
  ['wind_face', 'ðŸŒ¬ï¸'],
  ['fog', 'ðŸŒ«ï¸'],
  ['dog', 'ðŸ¶'],
  ['cat', 'ðŸ±'],
  ['mouse', 'ðŸ­'],
  ['rabbit', 'ðŸ°'],
  ['fox_face', 'ðŸ¦Š'],
  ['bear', 'ðŸ»'],
  ['panda_face', 'ðŸ¼'],
  ['koala', 'ðŸ¨'],
  ['tiger', 'ðŸ¯'],
  ['lion', 'ðŸ¦'],
  ['cow', 'ðŸ®'],
  ['pig', 'ðŸ·'],
  ['frog', 'ðŸ¸'],
  ['monkey_face', 'ðŸµ'],
  ['see_no_evil', 'ðŸ™ˆ'],
  ['hear_no_evil', 'ðŸ™‰'],
  ['speak_no_evil', 'ðŸ™Š'],
  ['chicken', 'ðŸ”'],
  ['penguin', 'ðŸ§'],
  ['bird', 'ðŸ¦'],
  ['baby_chick', 'ðŸ¤'],
  ['bee', 'ðŸ'],
  ['bug', 'ðŸ›'],
  ['butterfly', 'ðŸ¦‹'],
  ['snail', 'ðŸŒ'],
  ['turtle', 'ðŸ¢'],
  ['snake', 'ðŸ'],
  ['lizard', 'ðŸ¦Ž'],
  ['dragon', 'ðŸ‰'],
  ['whale', 'ðŸ³'],
  ['dolphin', 'ðŸ¬'],
  ['fish', 'ðŸŸ'],
  ['octopus', 'ðŸ™'],
  ['shell', 'ðŸš'],
  ['crab', 'ðŸ¦€'],
  ['tree', 'ðŸŒ²'],
  ['evergreen_tree', 'ðŸŒ²'],
  ['deciduous_tree', 'ðŸŒ³'],
  ['palm_tree', 'ðŸŒ´'],
  ['cactus', 'ðŸŒµ'],
  ['herb', 'ðŸŒ¿'],
  ['shamrock', 'â˜˜ï¸'],
  ['four_leaf_clover', 'ðŸ€'],
  ['maple_leaf', 'ðŸ'],
  ['fallen_leaf', 'ðŸ‚'],
  ['leaves', 'ðŸƒ'],
  ['mushroom', 'ðŸ„'],
  ['cherry_blossom', 'ðŸŒ¸'],
  ['rose', 'ðŸŒ¹'],
  ['hibiscus', 'ðŸŒº'],
  ['sunflower', 'ðŸŒ»'],
  ['blossom', 'ðŸŒ¼'],
  ['bouquet', 'ðŸ’'],
  ['seedling', 'ðŸŒ±'],
  ['christmas_tree', 'ðŸŽ„'],
  ['santa', 'ðŸŽ…'],
  ['gift_heart', 'ðŸ’'],
  ['ring', 'ðŸ’'],
  ['gem', 'ðŸ’Ž'],
  ['bulb', 'ðŸ’¡'],
  ['book', 'ðŸ“–'],
  ['pencil', 'ðŸ“'],
  ['memo', 'ðŸ“'],
  ['email', 'âœ‰ï¸'],
  ['envelope', 'âœ‰ï¸'],
  ['phone', 'â˜Žï¸'],
  ['telephone', 'â˜Žï¸'],
  ['iphone', 'ðŸ“±'],
  ['camera', 'ðŸ“·'],
  ['video_camera', 'ðŸ“¹'],
  ['tv', 'ðŸ“º'],
  ['computer', 'ðŸ’»'],
  ['keyboard', 'âŒ¨ï¸'],
  ['desktop_computer', 'ðŸ–¥ï¸'],
  ['printer', 'ðŸ–¨ï¸'],
  ['mouse', 'ðŸ–±ï¸'],
  ['trackball', 'ðŸ–²ï¸'],
  ['joystick', 'ðŸ•¹ï¸'],
  ['watch', 'âŒš'],
  ['alarm_clock', 'â°'],
  ['stopwatch', 'â±ï¸'],
  ['timer_clock', 'â²ï¸'],
  ['hourglass', 'âŒ›'],
  ['hourglass_flowing_sand', 'â³'],
  ['satellite_antenna', 'ðŸ“¡'],
  ['battery', 'ðŸ”‹'],
  ['electric_plug', 'ðŸ”Œ'],
  ['lock', 'ðŸ”’'],
  ['unlock', 'ðŸ”“'],
  ['key', 'ðŸ”‘'],
  ['mag', 'ðŸ”'],
  ['mag_right', 'ðŸ”Ž'],
  ['bell', 'ðŸ””'],
  ['no_bell', 'ðŸ”•'],
  ['bookmark', 'ðŸ”–'],
  ['link', 'ðŸ”—'],
  ['wrench', 'ðŸ”§'],
  ['hammer', 'ðŸ”¨'],
  ['nut_and_bolt', 'ðŸ”©'],
  ['thinking', 'ðŸ¤”'],
  ['thinking_face', 'ðŸ¤”'],
  ['question', 'â“'],
  ['grey_question', 'â”'],
  ['exclamation', 'â—'],
  ['grey_exclamation', 'â•'],
  ['warning', 'âš ï¸'],
  ['x', 'âŒ'],
  ['o', 'â­•'],
  ['white_check_mark', 'âœ…'],
  ['heavy_check_mark', 'âœ”ï¸'],
  ['accept', 'ðŸ‰‘'],
  ['satellite', 'ðŸ“¡'],
  ['arrow_up', 'â¬†ï¸'],
  ['arrow_down', 'â¬‡ï¸'],
  ['arrow_left', 'â¬…ï¸'],
  ['arrow_right', 'âž¡ï¸'],
  ['arrow_upper_right', 'â†—ï¸'],
  ['arrow_lower_right', 'â†˜ï¸'],
  ['arrow_lower_left', 'â†™ï¸'],
  ['arrow_upper_left', 'â†–ï¸'],
  ['arrow_up_down', 'â†•ï¸'],
  ['left_right_arrow', 'â†”ï¸'],
  ['arrows_counterclockwise', 'ðŸ”„'],
  ['back', 'ðŸ”™'],
  ['end', 'ðŸ”š'],
  ['on', 'ðŸ”›'],
  ['soon', 'ðŸ”œ'],
  ['top', 'ðŸ”'],
  ['red_circle', 'ðŸ”´'],
  ['blue_circle', 'ðŸ”µ'],
  ['white_circle', 'âšª'],
  ['black_circle', 'âš«'],
  ['red_square', 'ðŸŸ¥'],
  ['blue_square', 'ðŸŸ¦'],
  ['white_square', 'â¬œ'],
  ['black_square', 'â¬›'],
  ['orange_square', 'ðŸŸ§'],
  ['yellow_square', 'ðŸŸ¨'],
  ['green_square', 'ðŸŸ©'],
  ['purple_square', 'ðŸŸª'],
  ['brown_square', 'ðŸŸ«'],
  ['diamond_shape_with_a_dot_inside', 'ðŸ’ '],
  ['radio_button', 'ðŸ”˜'],
  ['white_square_button', 'ðŸ”³'],
  ['black_square_button', 'ðŸ”²'],
  ['scissors', 'âœ‚ï¸'],
  ['paperclip', 'ðŸ“Ž'],
  ['pushpin', 'ðŸ“Œ'],
  ['round_pushpin', 'ðŸ“'],
  ['triangular_flag_on_post', 'ðŸš©'],
  ['closed_book', 'ðŸ“•'],
  ['open_book', 'ðŸ“–'],
  ['green_book', 'ðŸ“—'],
  ['blue_book', 'ðŸ“˜'],
  ['orange_book', 'ï¿½orange_book'],
  ['notebook', 'ðŸ““'],
  ['ledger', 'ðŸ“’'],
  ['page_with_curl', 'ðŸ“ƒ'],
  ['scroll', 'ðŸ“œ'],
  ['page_facing_up', 'ðŸ“„'],
  ['newspaper', 'ðŸ“°'],
  ['bookmark_tabs', 'ðŸ“‘'],
  ['bar_chart', 'ðŸ“Š'],
  ['chart_with_upwards_trend', 'ðŸ“ˆ'],
  ['chart_with_downwards_trend', 'ðŸ“‰'],
  ['calendar', 'ðŸ“…'],
  ['date', 'ðŸ“†'],
  ['clipboard', 'ðŸ“‹'],
  ['file_folder', 'ðŸ“'],
  ['open_file_folder', 'ðŸ“‚'],
  ['briefcase', 'ðŸ’¼'],
  ['package', 'ðŸ“¦'],
  ['inbox_tray', 'ðŸ“¥'],
  ['outbox_tray', 'ðŸ“¤'],
  ['musical_note', 'ðŸŽµ'],
  ['notes', 'ðŸŽ¶'],
  ['microphone', 'ðŸŽ¤'],
  ['headphones', 'ðŸŽ§'],
  ['guitar', 'ðŸŽ¸'],
  ['trumpet', 'ðŸŽº'],
  ['saxophone', 'ðŸŽ·'],
  ['violin', 'ðŸŽ»'],
  ['drum', 'ðŸ¥'],
  ['clapper', 'ðŸŽ¬'],
  ['art', 'ðŸŽ¨'],
  ['performing_arts', 'ðŸŽ­'],
  ['game_die', 'ðŸŽ²'],
  ['slot_machine', 'ðŸŽ°'],
])

/**
 * Emoji parser for markdown-it
 * Only supports :emoji_name: syntax (no shortcuts/emoticons)
 * Uses Map for O(1) lookups and simple string scanning
 */
const emojiRule = (state: any, silent: boolean) => {
  const max = state.posMax
  const start = state.pos

  // Quick check: must start with ':'
  if (state.src.charCodeAt(start) !== 0x3A /* : */) {
    return false
  }

  // Find the closing ':'
  let pos = start + 1
  while (pos < max) {
    const code = state.src.charCodeAt(pos)

    // Found closing ':'
    if (code === 0x3A /* : */) {
      const emojiName = state.src.slice(start + 1, pos)

      // Check if this is a valid emoji
      const emojiChar = EMOJI_MAP.get(emojiName)
      if (emojiChar) {
        if (!silent) {
          const token = state.push('emoji', '', 0)
          token.markup = emojiName
          token.content = emojiChar
        }
        state.pos = pos + 1
        return true
      }

      // Not a valid emoji, stop searching
      return false
    }

    // Only allow word characters, digits, underscores, hyphens, and plus
    // This matches the pattern of valid emoji names
    if (
      (code >= 0x61 && code <= 0x7A) // a-z
      || (code >= 0x41 && code <= 0x5A) // A-Z
      || (code >= 0x30 && code <= 0x39) // 0-9
      || code === 0x5F // _
      || code === 0x2D // -
      || code === 0x2B // +
    ) {
      pos++
      continue
    }

    // Invalid character in emoji name
    return false
  }

  // No closing ':' found
  return false
}

export const markdownItEmoji: MarkdownItPlugin = (md) => {
  md.inline.ruler.before('emphasis', 'emoji', emojiRule)
}

export default function comarkEmoji(): ComarkPlugin {
  return {
    markdownItPlugins: [markdownItEmoji],
  }
}
